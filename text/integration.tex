% !TEX root = main.tex
\chapter{Integration into a Dialog System}
\label{cha:integration}
This chapter briefly discuss the technical details of interfacing
a decoder from a dialog system.
In addition, in~Section~\ref{sec:python_c_interface} we present our project specific issue.
Namely, interfacing C/C++ code from Python.

\todo{Python / C++ integration}

\todo{Evaluation of the online decoder}

\todo{udelat real time experiment }

\todo{Describe domain data training and test data only SDS Alex domain difference}


\section{Dialog system architecture} 
\label{sec:dialog_system_architecture}
The Alex dialog system is developed in Python language and consist of~six major components. 
\begin{enumerate}
    \item Voice Activity Detection (VAD)
    \item Automatic Speech Recognition (ASR) 
    \item Spoken Language Understanding (SLU)
    \item Dialog Manager (DM)
    \item Natural Language Generation (NLG)
    \item Text To Speech (TTS)
\end{enumerate}
The~Alex dialog system has a~speech to speech user interface. The~system interacts with the user in {\it turns}. During a~single turn the dialog system waits for a~user spoken input, process the speech and generates the reply.
The~data~flow during single turn is depicted in~Figure~\ref{fig:dialog_system}.

The integration task consist of:
\begin{itemize}
    \item Building a~Python interface for a~C++ Kaldi decoder.
    \item Define the input and output interface for the Kaldi decoder - wrapped by Automatic Speech Recognition (ASR) unit in Alex.
\end{itemize}
 The ASR unit takes output of~the VAD component and provides input for the SLU unit. 
 %The input and output interfaces are chosen according the real time needs of~the VAD unit and the SLU unit.

\begin{figure}
    \begin{center}
    \input{images/ds-diagram}
    \caption{Single turn in Alex dialog system}
    \label{fig:dialog_system} 
    \end{center}
\end{figure}

In our dialog system we experiment with different outputs of~a~speech decoder in Spoken Language Understanding unit. 
The decoder for our system should be able to generate {\it n-best lists}, {\it lattices} and {\it confusion networks} output.
% Ideally, the decoder for our system would be able to generate {\it n-best lists}, {\it lattices} and {\it confusion networks}.

%   d) output of~the decoder will be standard lattices 
%     (both phone and word)
%   e) compute posterior lattices (both phone and word),
%   f) provide confusion networks for these lattices
%   g) measure teh quality of~the lattices, depth, oracle error rate    

% section integrate_kaldi_decoder_into_vystadial_framework (end)


% \subsection{Development of~a~real time decoder}
% \label{sub:kaldi_rt_decoder}
% In the our dialog system we need above all a~real time decoder for the Kaldi toolkit. At first, we will identify what prevents the current Kaldi decoders from being used as real time decoders. 
% 
% Namely, we will explore problems with latency and suggest potential speed improvements e.g.\ approximations, use of~\ac{GPU}, and so on. Based on the experiments we will suggest the optimal setting for the real time use of~Kaldi decoder.
% 
% % section development_of_real_time_asr_decoder_for_the_kaldi_toolkit (end)

We will also compare and contrast possibilities of~different output formats for each of~tested decoders. The~memory consumption and the~stability of~decoders will be also observed. 



% section dialog_system_architecture (end)

\section{Python/C++ interface} 
\label{sec:python_c_interface}
Why I choose cffi and not traditional swig/ boost what so ever solution?

% section python_c_interface (end)

\todo{Contrast and compare with google. Julius?}

\section{Software development in Open Source community} 
\label{sec:software_development_in_open_source_community}
\todo{ Shortly say that the source code will be merged into Kaldi and also promote Alex which is going to be on Github}

\section{Evaluation on Alex data}
\label{sec:evalution}
\begin{verbatim}
    # waws:                  948
    Global RTF mean:         1.053494
    RTF median:              1.024411  RTF       < 1.123661 [in 95%]
    Forward RTF median:      0.228039  FWRTF     < 0.576542 [in 95%]
    Latency median:          0.039645  Latency   < 0.339410 [in 95%]
    Forward latency median:  0.000000  FWLatency < 0.000000 [in 95%]
    
    95%RTF=1.12 95%FWRTF=0.58 95%LAT=0.34 95%FWLAT=0.00


    Please note that the scoring is implicitly ignoring all non-speech events.
    
    Ref: decoded\_kaldi/ref\_trn.txt
    Tst: decoded\_kaldi/dec\_trn.txt
    |==============================================================================================|
    |            | # Sentences  |  # Words  |   Corr   |   Sub    |   Del    |   Ins    |   Err    |
    |----------------------------------------------------------------------------------------------|
    | Sum/Avg    |     948      |   2486    |  88.33   |   7.40   |   4.26   |   3.50   |  15.16   |
    |==============================================================================================|
    

real    15m49.998s
user    11m8.739s
sys     0m6.585s
\end{verbatim}

\begin{verbatim}
  # waws:                  948
    Global RTF mean:         1.064172
    RTF median:              1.026408  RTF       < 1.150286 [in 95%]
    Forward RTF median:      0.243869  FWRTF     < 0.623924 [in 95%]
    Latency median:          0.043117  Latency   < 0.404169 [in 95%]
    Forward latency median:  0.000000  FWLatency < 0.000000 [in 95%]
    
    95%RTF=1.15 95%FWRTF=0.62 95%LAT=0.40 95%FWLAT=0.00


    Please note that the scoring is implicitly ignoring all non-speech events.
    
    Ref: decoded_kaldi/ref_trn.txt
    Tst: decoded_kaldi/dec_trn.txt
    |=============================================================================================
=|
    |            | # Sentences  |  # Words  |   Corr   |   Sub    |   Del    |   Ins    |   Err   
 |
    |---------------------------------------------------------------------------------------------
-|
    | Sum/Avg    |     948      |   2265    |  89.71   |   6.23   |   4.06   |   2.87   |  13.16  
 |
    |=============================================================================================
=|
    

real    13m17.918s
user    13m4.224s
sys     0m6.265s
\end{verbatim}

% section evalution_on_alex_data (end)

% section software_development_in_open_source_community (end)

% chapter integration_into_dialog_system (end)
